<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>White Elephant Gift Exchange</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@500;700&family=DM+Sans:wght@400;500;600&display=swap" rel="stylesheet">
  <style>
    :root {
      --forest: #1a472a;
      --forest-light: #2d5a3d;
      --gold: #d4af37;
      --gold-light: #e8c85a;
      --cream: #faf8f3;
      --cream-dark: #f0ebe0;
      --burgundy: #722f37;
      --snow: #ffffff;
      --charcoal: #2c2c2c;
      --shadow: rgba(26, 71, 42, 0.15);
      --shadow-heavy: rgba(26, 71, 42, 0.25);
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'DM Sans', sans-serif;
      background: var(--cream);
      color: var(--charcoal);
      min-height: 100vh;
      min-height: 100dvh;
      overflow-x: hidden;
    }

    /* Background pattern */
    body::before {
      content: '';
      position: fixed;
      inset: 0;
      background-image: 
        radial-gradient(circle at 20% 80%, rgba(212, 175, 55, 0.08) 0%, transparent 50%),
        radial-gradient(circle at 80% 20%, rgba(26, 71, 42, 0.06) 0%, transparent 50%),
        radial-gradient(circle at 50% 50%, rgba(114, 47, 55, 0.04) 0%, transparent 70%);
      pointer-events: none;
      z-index: 0;
    }

    .screen {
      display: none;
      flex-direction: column;
      min-height: 100vh;
      min-height: 100dvh;
      padding: 1.5rem;
      position: relative;
      z-index: 1;
      animation: fadeIn 0.4s ease-out;
    }

    .screen.active {
      display: flex;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    @keyframes float {
      0%, 100% { transform: translateY(0) rotate(0deg); }
      50% { transform: translateY(-10px) rotate(2deg); }
    }

    @keyframes pulse {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.05); }
    }

    @keyframes shimmer {
      0% { background-position: -200% center; }
      100% { background-position: 200% center; }
    }

    @keyframes unwrap {
      0% { transform: scale(1) rotate(0deg); }
      25% { transform: scale(1.1) rotate(-5deg); }
      50% { transform: scale(1.2) rotate(5deg); }
      75% { transform: scale(1.1) rotate(-3deg); }
      100% { transform: scale(1) rotate(0deg); }
    }

    h1 {
      font-family: 'Playfair Display', serif;
      font-weight: 700;
      color: var(--forest);
    }

    h2, h3 {
      font-family: 'Playfair Display', serif;
      font-weight: 500;
      color: var(--forest);
    }

    /* Header */
    .header {
      text-align: center;
      padding: 1rem 0 2rem;
    }

    .logo {
      font-size: 2.5rem;
      margin-bottom: 0.25rem;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 0.5rem;
    }

    .logo-icon {
      font-size: 2rem;
      animation: float 3s ease-in-out infinite;
    }

    .tagline {
      color: var(--forest-light);
      font-size: 0.95rem;
      opacity: 0.8;
    }

    /* Cards */
    .card {
      background: var(--snow);
      border-radius: 1.25rem;
      padding: 1.75rem;
      box-shadow: 0 4px 20px var(--shadow);
      margin-bottom: 1.25rem;
    }

    .card-title {
      font-size: 1.1rem;
      margin-bottom: 1rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    /* Buttons */
    .btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 0.5rem;
      padding: 1rem 1.75rem;
      border: none;
      border-radius: 0.875rem;
      font-family: 'DM Sans', sans-serif;
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s ease;
      width: 100%;
    }

    .btn-primary {
      background: linear-gradient(135deg, var(--forest) 0%, var(--forest-light) 100%);
      color: var(--snow);
      box-shadow: 0 4px 15px var(--shadow-heavy);
    }

    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px var(--shadow-heavy);
    }

    .btn-primary:active {
      transform: translateY(0);
    }

    .btn-primary:disabled {
      opacity: 0.6;
      cursor: not-allowed;
      transform: none;
    }

    .btn-secondary {
      background: var(--cream);
      color: var(--forest);
      border: 2px solid var(--forest);
    }

    .btn-secondary:hover {
      background: var(--forest);
      color: var(--snow);
    }

    .btn-gold {
      background: linear-gradient(135deg, var(--gold) 0%, var(--gold-light) 100%);
      color: var(--charcoal);
      box-shadow: 0 4px 15px rgba(212, 175, 55, 0.3);
    }

    .btn-gold:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(212, 175, 55, 0.4);
    }

    .btn-small {
      padding: 0.625rem 1rem;
      font-size: 0.875rem;
    }

    /* Inputs */
    .input-group {
      margin-bottom: 1.25rem;
    }

    .input-group label {
      display: block;
      font-weight: 500;
      margin-bottom: 0.5rem;
      color: var(--forest);
    }

    .input-group input {
      width: 100%;
      padding: 0.875rem 1rem;
      border: 2px solid var(--cream-dark);
      border-radius: 0.75rem;
      font-family: 'DM Sans', sans-serif;
      font-size: 1rem;
      transition: border-color 0.2s ease;
    }

    .input-group input:focus {
      outline: none;
      border-color: var(--forest);
    }

    /* Image capture */
    .image-capture {
      position: relative;
      width: 100%;
      aspect-ratio: 1;
      max-width: 280px;
      margin: 0 auto 1.25rem;
      border-radius: 1rem;
      overflow: hidden;
      background: var(--cream-dark);
      border: 3px dashed var(--forest-light);
    }

    .image-capture.has-image {
      border-style: solid;
      border-color: var(--gold);
    }

    .image-capture video,
    .image-capture img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .image-capture .placeholder {
      position: absolute;
      inset: 0;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      color: var(--forest-light);
      gap: 0.5rem;
    }

    .placeholder-icon {
      font-size: 3rem;
      opacity: 0.6;
    }

    .capture-btns {
      display: flex;
      gap: 0.75rem;
      margin-bottom: 1rem;
    }

    .capture-btns .btn {
      flex: 1;
      padding: 0.75rem 1rem;
    }

    /* Room code display */
    .room-code-display {
      text-align: center;
      padding: 1.5rem;
      background: linear-gradient(135deg, var(--forest) 0%, var(--forest-light) 100%);
      border-radius: 1rem;
      margin-bottom: 1.5rem;
    }

    .room-code-label {
      color: rgba(255, 255, 255, 0.8);
      font-size: 0.875rem;
      margin-bottom: 0.5rem;
    }

    .room-code {
      font-family: 'Playfair Display', serif;
      font-size: 2.5rem;
      font-weight: 700;
      color: var(--gold);
      letter-spacing: 0.2em;
      text-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
    }

    /* Players list */
    .players-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
      gap: 1rem;
    }

    .player-card {
      background: var(--snow);
      border-radius: 1rem;
      padding: 1rem;
      text-align: center;
      box-shadow: 0 2px 10px var(--shadow);
      position: relative;
      transition: all 0.3s ease;
    }

    .player-card.current-turn {
      box-shadow: 0 0 0 3px var(--gold), 0 4px 20px var(--shadow-heavy);
      animation: pulse 1.5s ease-in-out infinite;
    }

    .player-card.has-gift::after {
      content: 'üéÅ';
      position: absolute;
      top: -8px;
      right: -8px;
      font-size: 1.5rem;
      filter: drop-shadow(0 2px 4px rgba(0,0,0,0.2));
    }

    .player-card.can-steal {
      cursor: pointer;
    }

    .player-card.can-steal:hover {
      transform: translateY(-4px);
      box-shadow: 0 0 0 3px var(--burgundy), 0 8px 25px var(--shadow-heavy);
    }

    .player-avatar {
      width: 70px;
      height: 70px;
      border-radius: 50%;
      object-fit: cover;
      margin-bottom: 0.75rem;
      border: 3px solid var(--cream);
      box-shadow: 0 2px 8px var(--shadow);
    }

    .player-name {
      font-weight: 600;
      font-size: 0.9rem;
      color: var(--forest);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .player-status {
      font-size: 0.75rem;
      color: var(--forest-light);
      margin-top: 0.25rem;
    }

    .host-badge {
      display: inline-block;
      background: var(--gold);
      color: var(--charcoal);
      font-size: 0.65rem;
      font-weight: 600;
      padding: 0.15rem 0.5rem;
      border-radius: 1rem;
      margin-top: 0.35rem;
    }

    /* Gift pool */
    .gift-pool {
      background: linear-gradient(135deg, var(--cream-dark) 0%, var(--cream) 100%);
      border-radius: 1.25rem;
      padding: 1.5rem;
      margin-bottom: 1.5rem;
      min-height: 200px;
    }

    .pool-title {
      text-align: center;
      margin-bottom: 1rem;
      font-size: 1.1rem;
    }

    .gifts-grid {
      display: flex;
      flex-wrap: wrap;
      gap: 1rem;
      justify-content: center;
    }

    .gift-box {
      width: 80px;
      height: 80px;
      background: linear-gradient(135deg, var(--burgundy) 0%, #8b3a42 100%);
      border-radius: 0.75rem;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 2.5rem;
      cursor: pointer;
      transition: all 0.3s ease;
      box-shadow: 0 4px 15px rgba(114, 47, 55, 0.3);
      position: relative;
      overflow: hidden;
    }

    .gift-box::before {
      content: '';
      position: absolute;
      top: 50%;
      left: -10%;
      right: -10%;
      height: 12px;
      background: var(--gold);
      transform: translateY(-50%);
    }

    .gift-box::after {
      content: '';
      position: absolute;
      left: 50%;
      top: -10%;
      bottom: -10%;
      width: 12px;
      background: var(--gold);
      transform: translateX(-50%);
    }

    .gift-box:hover {
      transform: translateY(-5px) rotate(3deg);
      box-shadow: 0 8px 25px rgba(114, 47, 55, 0.4);
    }

    .gift-box.selectable {
      animation: float 2s ease-in-out infinite;
    }

    .gift-box .bow {
      position: absolute;
      top: -5px;
      font-size: 1.5rem;
      z-index: 1;
    }

    /* Turn indicator */
    .turn-indicator {
      background: linear-gradient(135deg, var(--gold) 0%, var(--gold-light) 100%);
      border-radius: 1rem;
      padding: 1.25rem;
      text-align: center;
      margin-bottom: 1.5rem;
      box-shadow: 0 4px 15px rgba(212, 175, 55, 0.3);
    }

    .turn-indicator.your-turn {
      animation: pulse 1.5s ease-in-out infinite;
    }

    .turn-text {
      font-size: 1rem;
      font-weight: 600;
      color: var(--charcoal);
    }

    .turn-name {
      font-family: 'Playfair Display', serif;
      font-size: 1.5rem;
      font-weight: 700;
      color: var(--forest);
      margin-top: 0.25rem;
    }

    .turn-actions {
      display: flex;
      gap: 0.75rem;
      margin-top: 1rem;
    }

    .turn-actions .btn {
      flex: 1;
    }

    /* Reveal screen */
    .reveal-container {
      flex: 1;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      text-align: center;
      padding: 2rem 0;
    }

    .reveal-gift {
      background: var(--snow);
      border-radius: 1.5rem;
      padding: 2rem;
      max-width: 350px;
      width: 100%;
      box-shadow: 0 8px 40px var(--shadow-heavy);
      animation: unwrap 0.8s ease-out;
    }

    .reveal-gift-image {
      width: 100%;
      aspect-ratio: 1;
      object-fit: cover;
      border-radius: 1rem;
      margin-bottom: 1.25rem;
      box-shadow: 0 4px 15px var(--shadow);
    }

    .reveal-gift-title {
      font-family: 'Playfair Display', serif;
      font-size: 1.5rem;
      color: var(--forest);
      margin-bottom: 1.5rem;
    }

    .reveal-info {
      display: flex;
      justify-content: space-between;
      gap: 1rem;
    }

    .reveal-person {
      flex: 1;
      text-align: center;
    }

    .reveal-person-label {
      font-size: 0.75rem;
      color: var(--forest-light);
      margin-bottom: 0.5rem;
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }

    .reveal-person-avatar {
      width: 50px;
      height: 50px;
      border-radius: 50%;
      object-fit: cover;
      margin-bottom: 0.35rem;
      border: 2px solid var(--cream);
    }

    .reveal-person-name {
      font-weight: 600;
      font-size: 0.9rem;
      color: var(--forest);
    }

    .arrow-icon {
      display: flex;
      align-items: center;
      font-size: 1.5rem;
      color: var(--gold);
    }

    /* Results */
    .results-list {
      display: flex;
      flex-direction: column;
      gap: 1rem;
    }

    .result-item {
      display: flex;
      align-items: center;
      gap: 1rem;
      background: var(--snow);
      border-radius: 1rem;
      padding: 1rem;
      box-shadow: 0 2px 10px var(--shadow);
    }

    .result-gift-img {
      width: 60px;
      height: 60px;
      object-fit: cover;
      border-radius: 0.75rem;
    }

    .result-info {
      flex: 1;
    }

    .result-title {
      font-weight: 600;
      color: var(--forest);
      margin-bottom: 0.25rem;
    }

    .result-people {
      font-size: 0.85rem;
      color: var(--forest-light);
    }

    /* Toast notifications */
    .toast-container {
      position: fixed;
      bottom: 1.5rem;
      left: 50%;
      transform: translateX(-50%);
      z-index: 1000;
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
      pointer-events: none;
    }

    .toast {
      background: var(--forest);
      color: var(--snow);
      padding: 1rem 1.5rem;
      border-radius: 1rem;
      font-weight: 500;
      box-shadow: 0 4px 20px var(--shadow-heavy);
      animation: slideUp 0.3s ease-out;
      text-align: center;
      max-width: 90vw;
    }

    @keyframes slideUp {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }

    /* Waiting dots */
    .waiting-dots {
      display: inline-flex;
      gap: 0.25rem;
    }

    .waiting-dots span {
      width: 8px;
      height: 8px;
      background: var(--forest);
      border-radius: 50%;
      animation: bounce 1.4s infinite ease-in-out both;
    }

    .waiting-dots span:nth-child(1) { animation-delay: -0.32s; }
    .waiting-dots span:nth-child(2) { animation-delay: -0.16s; }

    @keyframes bounce {
      0%, 80%, 100% { transform: scale(0); }
      40% { transform: scale(1); }
    }

    /* Empty state */
    .empty-state {
      text-align: center;
      padding: 2rem;
      color: var(--forest-light);
    }

    .empty-icon {
      font-size: 3rem;
      margin-bottom: 0.5rem;
      opacity: 0.5;
    }

    /* Scrollable area */
    .scroll-area {
      flex: 1;
      overflow-y: auto;
      -webkit-overflow-scrolling: touch;
    }

    /* Confetti canvas */
    #confetti {
      position: fixed;
      inset: 0;
      pointer-events: none;
      z-index: 999;
    }

    /* Hidden file input */
    input[type="file"] {
      display: none;
    }

    /* Status indicators */
    .status-ready {
      color: var(--forest);
    }

    .status-waiting {
      color: var(--gold);
    }

    /* Media queries */
    @media (min-width: 640px) {
      .screen {
        max-width: 500px;
        margin: 0 auto;
        padding: 2rem;
      }

      .logo {
        font-size: 3rem;
      }

      .players-grid {
        grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
      }
    }

    @media (max-height: 700px) {
      .header {
        padding: 0.5rem 0 1rem;
      }

      .logo {
        font-size: 2rem;
      }

      .card {
        padding: 1.25rem;
      }
    }

    /* Steal mode indicator */
    .steal-mode-banner {
      background: linear-gradient(135deg, var(--burgundy) 0%, #8b3a42 100%);
      color: var(--snow);
      padding: 0.75rem 1rem;
      border-radius: 0.75rem;
      text-align: center;
      margin-bottom: 1rem;
      font-weight: 500;
    }

    /* Your gift preview */
    .your-gift-preview {
      background: var(--cream-dark);
      border-radius: 1rem;
      padding: 1rem;
      display: flex;
      align-items: center;
      gap: 1rem;
      margin-top: 1rem;
    }

    .your-gift-preview img {
      width: 60px;
      height: 60px;
      object-fit: cover;
      border-radius: 0.75rem;
    }

    .your-gift-preview .gift-info {
      flex: 1;
    }

    .your-gift-preview .gift-label {
      font-size: 0.75rem;
      color: var(--forest-light);
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }

    .your-gift-preview .gift-title {
      font-weight: 600;
      color: var(--forest);
    }
  </style>
</head>
<body>
  <canvas id="confetti"></canvas>
  <div class="toast-container" id="toastContainer"></div>

  <!-- Screen 1: Welcome -->
  <div id="welcomeScreen" class="screen active">
    <div class="header">
      <h1 class="logo">
        <span class="logo-icon">üéÅ</span>
        White Elephant
      </h1>
      <p class="tagline">Virtual Gift Exchange</p>
    </div>

    <div class="card">
      <h3 class="card-title">üéÑ Join a Game</h3>
      <div class="input-group">
        <label for="roomCodeInput">Room Code</label>
        <input type="text" id="roomCodeInput" placeholder="Enter 6-letter code" maxlength="6" autocapitalize="characters">
      </div>
      <button class="btn btn-primary" id="joinRoomBtn">Join Room</button>
    </div>

    <div class="card">
      <h3 class="card-title">‚ú® Create New Game</h3>
      <p style="color: var(--forest-light); margin-bottom: 1rem; font-size: 0.9rem;">
        Start a new game and invite your friends with the room code.
      </p>
      <button class="btn btn-secondary" id="createRoomBtn">Create Room</button>
    </div>
  </div>

  <!-- Screen 2: Create Avatar -->
  <div id="avatarScreen" class="screen">
    <div class="header">
      <h1 class="logo">
        <span class="logo-icon">üì∏</span>
        Your Avatar
      </h1>
      <p class="tagline">Let everyone see who you are</p>
    </div>

    <div class="card">
      <div class="input-group">
        <label for="playerNameInput">Your Name</label>
        <input type="text" id="playerNameInput" placeholder="Enter your name" maxlength="20">
      </div>

      <label style="display: block; font-weight: 500; margin-bottom: 0.5rem; color: var(--forest);">Your Photo</label>
      <div class="image-capture" id="avatarCapture">
        <video id="avatarVideo" autoplay playsinline style="display: none;"></video>
        <img id="avatarPreview" style="display: none;">
        <div class="placeholder" id="avatarPlaceholder">
          <span class="placeholder-icon">üë§</span>
          <span>Take or upload a photo</span>
        </div>
      </div>

      <div class="capture-btns">
        <button class="btn btn-secondary btn-small" id="avatarCameraBtn">üì∑ Camera</button>
        <button class="btn btn-secondary btn-small" id="avatarUploadBtn">üìÅ Upload</button>
      </div>
      <button class="btn btn-secondary btn-small" id="avatarCaptureBtn" style="display: none; margin-bottom: 1rem;">üì∏ Take Photo</button>
      <input type="file" id="avatarFileInput" accept="image/*">

      <button class="btn btn-primary" id="saveAvatarBtn" disabled>Continue to Gift</button>
    </div>
  </div>

  <!-- Screen 3: Add Gift -->
  <div id="giftScreen" class="screen">
    <div class="header">
      <h1 class="logo">
        <span class="logo-icon">üéÅ</span>
        Your Gift
      </h1>
      <p class="tagline">Only you can see this until the reveal</p>
    </div>

    <div class="card">
      <div class="input-group">
        <label for="giftTitleInput">Gift Title</label>
        <input type="text" id="giftTitleInput" placeholder="What is your gift?" maxlength="50">
      </div>

      <label style="display: block; font-weight: 500; margin-bottom: 0.5rem; color: var(--forest);">Gift Photo</label>
      <div class="image-capture" id="giftCapture">
        <video id="giftVideo" autoplay playsinline style="display: none;"></video>
        <img id="giftPreview" style="display: none;">
        <div class="placeholder" id="giftPlaceholder">
          <span class="placeholder-icon">üéÅ</span>
          <span>Take or upload a photo</span>
        </div>
      </div>

      <div class="capture-btns">
        <button class="btn btn-secondary btn-small" id="giftCameraBtn">üì∑ Camera</button>
        <button class="btn btn-secondary btn-small" id="giftUploadBtn">üìÅ Upload</button>
      </div>
      <button class="btn btn-secondary btn-small" id="giftCaptureBtn" style="display: none; margin-bottom: 1rem;">üì∏ Take Photo</button>
      <input type="file" id="giftFileInput" accept="image/*">

      <button class="btn btn-primary" id="saveGiftBtn" disabled>Join Lobby</button>
    </div>
  </div>

  <!-- Screen 4: Lobby -->
  <div id="lobbyScreen" class="screen">
    <div class="room-code-display">
      <div class="room-code-label">Share this code with friends</div>
      <div class="room-code" id="lobbyRoomCode">------</div>
      <div id="shareLink" style="margin-top: 0.75rem;">
        <button class="btn btn-small" id="copyLinkBtn" style="background: rgba(255,255,255,0.2); color: white; border: 1px solid rgba(255,255,255,0.3); padding: 0.5rem 1rem;">
          üìã Copy Invite Link
        </button>
      </div>
    </div>

    <div class="card">
      <h3 class="card-title">
        üë• Players
        <span class="waiting-dots"><span></span><span></span><span></span></span>
      </h3>
      <div class="players-grid" id="lobbyPlayers"></div>
    </div>

    <div style="margin-top: auto;">
      <div id="hostControls" style="display: none;">
        <button class="btn btn-gold" id="startGameBtn" disabled>
          üéÆ Start Game
        </button>
        <p style="text-align: center; margin-top: 0.75rem; font-size: 0.85rem; color: var(--forest-light);">
          All players must submit their gifts first
        </p>
      </div>
      <div id="waitingForHost" style="text-align: center; padding: 1rem;">
        <p style="color: var(--forest-light);">Waiting for host to start the game...</p>
      </div>
    </div>
  </div>

  <!-- Screen 5: Game -->
  <div id="gameScreen" class="screen">
    <div class="turn-indicator" id="turnIndicator">
      <div class="turn-text">Current Turn</div>
      <div class="turn-name" id="currentTurnName">---</div>
    </div>

    <div id="yourTurnActions" style="display: none;">
      <div class="turn-actions">
        <button class="btn btn-primary" id="takeFromPoolBtn">üéÅ Take from Pool</button>
        <button class="btn btn-secondary" id="stealGiftBtn">üòà Steal a Gift</button>
      </div>
    </div>

    <div id="stealModeBanner" class="steal-mode-banner" style="display: none;">
      üëÜ Tap a player's card to steal their gift!
      <button class="btn btn-small btn-secondary" id="cancelStealBtn" style="margin-top: 0.5rem;">Cancel</button>
    </div>

    <div class="scroll-area">
      <div class="gift-pool" id="giftPool">
        <h3 class="pool-title">üéÑ Gift Pool</h3>
        <div class="gifts-grid" id="giftsGrid"></div>
      </div>

      <div class="card">
        <h3 class="card-title">üë• Players & Their Gifts</h3>
        <div class="players-grid" id="gamePlayers"></div>
      </div>
    </div>
  </div>

  <!-- Screen 6: Reveal -->
  <div id="revealScreen" class="screen">
    <div class="header">
      <h1 class="logo">
        <span class="logo-icon">üéâ</span>
        Gift Reveal
      </h1>
      <p class="tagline">Let's see what everyone got!</p>
    </div>

    <div class="reveal-container" id="revealContainer">
      <div id="revealGiftCard" class="reveal-gift" style="display: none;">
        <img id="revealGiftImage" class="reveal-gift-image" src="" alt="Gift">
        <h2 id="revealGiftTitle" class="reveal-gift-title">---</h2>
        <div class="reveal-info">
          <div class="reveal-person">
            <div class="reveal-person-label">From</div>
            <img id="revealCreatorAvatar" class="reveal-person-avatar" src="" alt="">
            <div id="revealCreatorName" class="reveal-person-name">---</div>
          </div>
          <div class="arrow-icon">‚ûú</div>
          <div class="reveal-person">
            <div class="reveal-person-label">To</div>
            <img id="revealOwnerAvatar" class="reveal-person-avatar" src="" alt="">
            <div id="revealOwnerName" class="reveal-person-name">---</div>
          </div>
        </div>
      </div>

      <div id="revealWaiting" style="text-align: center;">
        <p style="font-size: 1.25rem; color: var(--forest); margin-bottom: 1rem;">Ready to reveal gifts!</p>
      </div>
    </div>

    <button class="btn btn-gold" id="revealNextBtn">‚ú® Reveal Next Gift</button>
  </div>

  <!-- Screen 7: Finished -->
  <div id="finishedScreen" class="screen">
    <div class="header">
      <h1 class="logo">
        <span class="logo-icon">üéä</span>
        Game Complete!
      </h1>
      <p class="tagline">Don't forget to mail your gifts!</p>
    </div>

    <div class="scroll-area">
      <div class="card">
        <h3 class="card-title">üéÅ Final Results</h3>
        <div class="results-list" id="resultsList"></div>
      </div>
    </div>

    <button class="btn btn-primary" id="playAgainBtn" style="margin-top: 1rem;">üîÑ Play Again</button>
  </div>

  <script src="/socket.io/socket.io.js"></script>
  <script>
    // App State
    const state = {
      socket: null,
      roomCode: null,
      playerId: null,
      playerName: null,
      playerAvatar: null,
      giftTitle: null,
      giftImage: null,
      roomState: null,
      isStealMode: false,
      videoStream: null
    };

    // DOM Elements
    const screens = {
      welcome: document.getElementById('welcomeScreen'),
      avatar: document.getElementById('avatarScreen'),
      gift: document.getElementById('giftScreen'),
      lobby: document.getElementById('lobbyScreen'),
      game: document.getElementById('gameScreen'),
      reveal: document.getElementById('revealScreen'),
      finished: document.getElementById('finishedScreen')
    };

    // Initialize Socket.io
    function initSocket() {
      state.socket = io();

      state.socket.on('connect', () => {
        console.log('Connected to server');
        checkUrlForRoom();
      });

      state.socket.on('roomUpdate', (roomState) => {
        state.roomState = roomState;
        updateUI();
      });

      state.socket.on('gameStarted', () => {
        showScreen('game');
        showToast('üéÆ Game started!');
      });

      state.socket.on('giftTaken', ({ playerName, fromPool }) => {
        if (fromPool) {
          showToast(`${playerName} took a gift from the pool!`);
        }
      });

      state.socket.on('giftStolen', ({ thiefName, victimName }) => {
        showToast(`üòà ${thiefName} stole from ${victimName}!`);
      });

      state.socket.on('revealPhase', () => {
        showScreen('reveal');
        showToast('üéâ Time to reveal the gifts!');
      });

      state.socket.on('giftRevealed', (revealData) => {
        showRevealedGift(revealData);
        triggerConfetti();
      });

      state.socket.on('gameFinished', () => {
        showScreen('finished');
        triggerConfetti();
        showToast('üéä Game complete! Happy gifting!');
      });
    }

    // Screen Navigation
    function showScreen(screenName) {
      Object.values(screens).forEach(s => s.classList.remove('active'));
      screens[screenName].classList.add('active');
      stopVideoStream();
    }

    // Toast Notifications
    function showToast(message, duration = 3000) {
      const container = document.getElementById('toastContainer');
      const toast = document.createElement('div');
      toast.className = 'toast';
      toast.textContent = message;
      container.appendChild(toast);
      setTimeout(() => toast.remove(), duration);
    }

    // Image Capture Helpers
    async function startCamera(videoElement) {
      try {
        const stream = await navigator.mediaDevices.getUserMedia({ 
          video: { facingMode: 'user', width: { ideal: 640 }, height: { ideal: 640 } } 
        });
        state.videoStream = stream;
        videoElement.srcObject = stream;
        videoElement.style.display = 'block';
        return true;
      } catch (err) {
        console.error('Camera error:', err);
        showToast('Could not access camera. Please upload an image.');
        return false;
      }
    }

    function stopVideoStream() {
      if (state.videoStream) {
        state.videoStream.getTracks().forEach(track => track.stop());
        state.videoStream = null;
      }
    }

    function captureFromVideo(videoElement) {
      const canvas = document.createElement('canvas');
      canvas.width = 400;
      canvas.height = 400;
      const ctx = canvas.getContext('2d');
      
      // Calculate crop to square
      const size = Math.min(videoElement.videoWidth, videoElement.videoHeight);
      const x = (videoElement.videoWidth - size) / 2;
      const y = (videoElement.videoHeight - size) / 2;
      
      ctx.drawImage(videoElement, x, y, size, size, 0, 0, 400, 400);
      return canvas.toDataURL('image/jpeg', 0.8);
    }

    function handleFileUpload(file, callback) {
      const reader = new FileReader();
      reader.onload = (e) => {
        const img = new Image();
        img.onload = () => {
          const canvas = document.createElement('canvas');
          canvas.width = 400;
          canvas.height = 400;
          const ctx = canvas.getContext('2d');
          
          // Crop to square
          const size = Math.min(img.width, img.height);
          const x = (img.width - size) / 2;
          const y = (img.height - size) / 2;
          
          ctx.drawImage(img, x, y, size, size, 0, 0, 400, 400);
          callback(canvas.toDataURL('image/jpeg', 0.8));
        };
        img.src = e.target.result;
      };
      reader.readAsDataURL(file);
    }

    // Welcome Screen
    document.getElementById('joinRoomBtn').addEventListener('click', () => {
      const code = document.getElementById('roomCodeInput').value.trim().toUpperCase();
      if (code.length !== 6) {
        showToast('Please enter a 6-letter room code');
        return;
      }
      state.roomCode = code;
      showScreen('avatar');
    });

    document.getElementById('createRoomBtn').addEventListener('click', () => {
      state.socket.emit('createRoom', (response) => {
        if (response.success) {
          state.roomCode = response.roomCode;
          showScreen('avatar');
          showToast(`Room created: ${response.roomCode}`);
        }
      });
    });

    // Avatar Screen
    const avatarVideo = document.getElementById('avatarVideo');
    const avatarPreview = document.getElementById('avatarPreview');
    const avatarPlaceholder = document.getElementById('avatarPlaceholder');
    const avatarCapture = document.getElementById('avatarCapture');

    document.getElementById('avatarCameraBtn').addEventListener('click', async () => {
      avatarPreview.style.display = 'none';
      avatarPlaceholder.style.display = 'none';
      const success = await startCamera(avatarVideo);
      if (success) {
        document.getElementById('avatarCaptureBtn').style.display = 'block';
      }
    });

    document.getElementById('avatarCaptureBtn').addEventListener('click', () => {
      state.playerAvatar = captureFromVideo(avatarVideo);
      avatarPreview.src = state.playerAvatar;
      avatarPreview.style.display = 'block';
      avatarVideo.style.display = 'none';
      avatarCapture.classList.add('has-image');
      document.getElementById('avatarCaptureBtn').style.display = 'none';
      stopVideoStream();
      validateAvatarForm();
    });

    document.getElementById('avatarUploadBtn').addEventListener('click', () => {
      document.getElementById('avatarFileInput').click();
    });

    document.getElementById('avatarFileInput').addEventListener('change', (e) => {
      if (e.target.files[0]) {
        handleFileUpload(e.target.files[0], (dataUrl) => {
          state.playerAvatar = dataUrl;
          avatarPreview.src = dataUrl;
          avatarPreview.style.display = 'block';
          avatarVideo.style.display = 'none';
          avatarPlaceholder.style.display = 'none';
          avatarCapture.classList.add('has-image');
          stopVideoStream();
          document.getElementById('avatarCaptureBtn').style.display = 'none';
          validateAvatarForm();
        });
      }
    });

    document.getElementById('playerNameInput').addEventListener('input', validateAvatarForm);

    function validateAvatarForm() {
      const name = document.getElementById('playerNameInput').value.trim();
      const hasAvatar = state.playerAvatar !== null;
      document.getElementById('saveAvatarBtn').disabled = !name || !hasAvatar;
    }

    document.getElementById('saveAvatarBtn').addEventListener('click', () => {
      state.playerName = document.getElementById('playerNameInput').value.trim();
      showScreen('gift');
    });

    // Gift Screen
    const giftVideo = document.getElementById('giftVideo');
    const giftPreview = document.getElementById('giftPreview');
    const giftPlaceholder = document.getElementById('giftPlaceholder');
    const giftCapture = document.getElementById('giftCapture');

    document.getElementById('giftCameraBtn').addEventListener('click', async () => {
      giftPreview.style.display = 'none';
      giftPlaceholder.style.display = 'none';
      const success = await startCamera(giftVideo);
      if (success) {
        document.getElementById('giftCaptureBtn').style.display = 'block';
      }
    });

    document.getElementById('giftCaptureBtn').addEventListener('click', () => {
      state.giftImage = captureFromVideo(giftVideo);
      giftPreview.src = state.giftImage;
      giftPreview.style.display = 'block';
      giftVideo.style.display = 'none';
      giftCapture.classList.add('has-image');
      document.getElementById('giftCaptureBtn').style.display = 'none';
      stopVideoStream();
      validateGiftForm();
    });

    document.getElementById('giftUploadBtn').addEventListener('click', () => {
      document.getElementById('giftFileInput').click();
    });

    document.getElementById('giftFileInput').addEventListener('change', (e) => {
      if (e.target.files[0]) {
        handleFileUpload(e.target.files[0], (dataUrl) => {
          state.giftImage = dataUrl;
          giftPreview.src = dataUrl;
          giftPreview.style.display = 'block';
          giftVideo.style.display = 'none';
          giftPlaceholder.style.display = 'none';
          giftCapture.classList.add('has-image');
          stopVideoStream();
          document.getElementById('giftCaptureBtn').style.display = 'none';
          validateGiftForm();
        });
      }
    });

    document.getElementById('giftTitleInput').addEventListener('input', validateGiftForm);

    function validateGiftForm() {
      const title = document.getElementById('giftTitleInput').value.trim();
      const hasImage = state.giftImage !== null;
      document.getElementById('saveGiftBtn').disabled = !title || !hasImage;
    }

    document.getElementById('saveGiftBtn').addEventListener('click', () => {
      state.giftTitle = document.getElementById('giftTitleInput').value.trim();
      joinRoom();
    });

    // Join Room
    function joinRoom() {
      state.socket.emit('joinRoom', {
        roomCode: state.roomCode,
        playerName: state.playerName,
        avatar: state.playerAvatar
      }, (response) => {
        if (response.success) {
          state.playerId = response.playerId;
          state.roomState = response.roomState;
          
          // Submit gift
          state.socket.emit('submitGift', {
            title: state.giftTitle,
            image: state.giftImage
          }, (giftResponse) => {
            if (giftResponse.success) {
              showScreen('lobby');
              updateUI();
            } else {
              showToast(giftResponse.error);
            }
          });
        } else {
          showToast(response.error);
        }
      });
    }

    // Lobby Screen
    document.getElementById('copyLinkBtn').addEventListener('click', () => {
      const link = `${window.location.origin}?room=${state.roomCode}`;
      navigator.clipboard.writeText(link).then(() => {
        showToast('‚úÖ Link copied to clipboard!');
      }).catch(() => {
        // Fallback for browsers without clipboard API
        showToast(`Share this link: ${link}`);
      });
    });

    document.getElementById('startGameBtn').addEventListener('click', () => {
      const btn = document.getElementById('startGameBtn');
      btn.disabled = true;
      btn.textContent = '‚è≥ Starting...';
      showToast('Starting game...');
      
      state.socket.emit('startGame', (response) => {
        if (!response.success) {
          showToast('‚ùå ' + response.error);
          btn.disabled = false;
          btn.textContent = 'üéÆ Start Game';
        }
        // On success, the gameStarted event will handle the transition
      });
    });

    // Game Screen
    document.getElementById('takeFromPoolBtn').addEventListener('click', () => {
      const pool = state.roomState.giftsInPool;
      if (pool.length > 0) {
        // Take the first available gift
        state.socket.emit('takeFromPool', { giftId: pool[0].id }, (response) => {
          if (!response.success) {
            showToast(response.error);
          }
        });
      }
    });

    document.getElementById('stealGiftBtn').addEventListener('click', () => {
      state.isStealMode = true;
      updateUI();
    });

    document.getElementById('cancelStealBtn').addEventListener('click', () => {
      state.isStealMode = false;
      updateUI();
    });

    // Reveal Screen
    document.getElementById('revealNextBtn').addEventListener('click', () => {
      state.socket.emit('revealNext', (response) => {
        if (!response.success) {
          showToast(response.error);
        }
      });
    });

    function showRevealedGift(data) {
      document.getElementById('revealWaiting').style.display = 'none';
      const card = document.getElementById('revealGiftCard');
      card.style.display = 'block';
      card.style.animation = 'none';
      card.offsetHeight; // Trigger reflow
      card.style.animation = 'unwrap 0.8s ease-out';

      document.getElementById('revealGiftImage').src = data.image;
      document.getElementById('revealGiftTitle').textContent = data.title;
      document.getElementById('revealCreatorAvatar').src = data.creatorAvatar;
      document.getElementById('revealCreatorName').textContent = data.creatorName;
      document.getElementById('revealOwnerAvatar').src = data.ownerAvatar;
      document.getElementById('revealOwnerName').textContent = data.ownerName;
    }

    // Finished Screen
    document.getElementById('playAgainBtn').addEventListener('click', () => {
      location.reload();
    });

    // Update UI
    function updateUI() {
      if (!state.roomState) return;

      const rs = state.roomState;

      // Update lobby room code
      document.getElementById('lobbyRoomCode').textContent = rs.code;

      // Update lobby players
      const lobbyPlayers = document.getElementById('lobbyPlayers');
      lobbyPlayers.innerHTML = rs.players.map(p => `
        <div class="player-card ${p.hasGift ? 'has-gift' : ''}">
          <img src="${p.avatar}" alt="${p.name}" class="player-avatar">
          <div class="player-name">${p.name}</div>
          <div class="player-status ${p.hasGift ? 'status-ready' : 'status-waiting'}">
            ${p.hasGift ? '‚úì Gift ready' : 'Adding gift...'}
          </div>
          ${p.isHost ? '<span class="host-badge">HOST</span>' : ''}
        </div>
      `).join('');

      // Show/hide host controls
      const isHost = rs.hostId === state.playerId;
      document.getElementById('hostControls').style.display = isHost ? 'block' : 'none';
      document.getElementById('waitingForHost').style.display = isHost ? 'none' : 'block';

      // Enable start button if all players have gifts
      const allReady = rs.players.every(p => p.hasGift);
      document.getElementById('startGameBtn').disabled = !allReady || rs.players.length < 2;

      // Update game screen
      if (rs.phase === 'playing') {
        const currentPlayer = rs.players.find(p => p.id === rs.currentPlayerId);
        document.getElementById('currentTurnName').textContent = currentPlayer?.name || '---';
        
        const isMyTurn = rs.currentPlayerId === state.playerId;
        const turnIndicator = document.getElementById('turnIndicator');
        turnIndicator.classList.toggle('your-turn', isMyTurn);

        // Show/hide action buttons
        document.getElementById('yourTurnActions').style.display = isMyTurn && !state.isStealMode ? 'block' : 'none';
        document.getElementById('stealModeBanner').style.display = state.isStealMode ? 'block' : 'none';

        // Check if stealing is possible (anyone else has a gift)
        const playersWithGifts = rs.players.filter(p => 
          rs.playerGifts[p.id] && p.id !== state.playerId
        );
        const canSteal = playersWithGifts.length > 0;
        
        // Check steal-back rule
        const canStealFromPlayer = (playerId) => {
          const playerGift = Object.entries(rs.playerGifts).find(([ownerId]) => ownerId === playerId);
          if (playerGift && playerGift[0] === rs.lastStolenFromPlayerId) {
            // This player just had their gift stolen, check if it's the same gift
            const giftId = Object.keys(rs.playerGifts).find(gId => rs.playerGifts[gId] === playerId);
            return giftId !== rs.lastStolenGiftId;
          }
          return true;
        };

        document.getElementById('stealGiftBtn').style.display = canSteal ? 'inline-flex' : 'none';

        // Disable take from pool if empty
        document.getElementById('takeFromPoolBtn').disabled = rs.giftsInPool.length === 0;

        // Update gift pool
        const giftsGrid = document.getElementById('giftsGrid');
        if (rs.giftsInPool.length === 0) {
          giftsGrid.innerHTML = '<div class="empty-state"><div class="empty-icon">üì≠</div><div>Pool is empty!</div></div>';
        } else {
          giftsGrid.innerHTML = rs.giftsInPool.map(g => `
            <div class="gift-box ${isMyTurn ? 'selectable' : ''}" data-gift-id="${g.id}">
              <span class="bow">üéÄ</span>
            </div>
          `).join('');

          // Add click handlers to gifts
          if (isMyTurn) {
            giftsGrid.querySelectorAll('.gift-box').forEach(box => {
              box.addEventListener('click', () => {
                const giftId = box.dataset.giftId;
                state.socket.emit('takeFromPool', { giftId }, (response) => {
                  if (!response.success) {
                    showToast(response.error);
                  }
                });
              });
            });
          }
        }

        // Update players with gifts
        const gamePlayers = document.getElementById('gamePlayers');
        gamePlayers.innerHTML = rs.players.map(p => {
          const hasGift = rs.playerGifts[p.id];
          const isCurrentTurn = p.id === rs.currentPlayerId;
          const canStealThis = state.isStealMode && hasGift && p.id !== state.playerId && isMyTurn;
          
          // Check steal-back rule for this player
          const giftEntry = Object.entries(rs.playerGifts).find(([gId, ownerId]) => ownerId === p.id);
          const giftId = giftEntry ? giftEntry[0] : null;
          const isStealBackBlocked = giftId === rs.lastStolenGiftId;

          return `
            <div class="player-card ${isCurrentTurn ? 'current-turn' : ''} ${hasGift ? 'has-gift' : ''} ${canStealThis && !isStealBackBlocked ? 'can-steal' : ''}" 
                 data-player-id="${p.id}" 
                 ${canStealThis && !isStealBackBlocked ? 'onclick="stealFromPlayer(\'' + p.id + '\')"' : ''}>
              <img src="${p.avatar}" alt="${p.name}" class="player-avatar">
              <div class="player-name">${p.name}${p.id === state.playerId ? ' (You)' : ''}</div>
              <div class="player-status">
                ${hasGift ? 'üéÅ Has gift' : 'No gift yet'}
                ${isStealBackBlocked && state.isStealMode ? '<br><small style="color: var(--burgundy);">Protected</small>' : ''}
              </div>
            </div>
          `;
        }).join('');
      }

      // Update results screen
      if (rs.phase === 'finished') {
        const resultsList = document.getElementById('resultsList');
        resultsList.innerHTML = rs.revealedGifts.map(g => `
          <div class="result-item">
            <img src="${g.image}" alt="${g.title}" class="result-gift-img">
            <div class="result-info">
              <div class="result-title">${g.title}</div>
              <div class="result-people">
                From <strong>${g.creatorName}</strong> ‚Üí To <strong>${g.ownerName}</strong>
              </div>
            </div>
          </div>
        `).join('');
      }
    }

    // Global steal function
    window.stealFromPlayer = function(fromPlayerId) {
      if (!state.isStealMode) return;
      
      state.socket.emit('stealGift', { fromPlayerId }, (response) => {
        if (!response.success) {
          showToast(response.error);
        }
        state.isStealMode = false;
        updateUI();
      });
    };

    // Confetti
    function triggerConfetti() {
      const canvas = document.getElementById('confetti');
      const ctx = canvas.getContext('2d');
      canvas.width = window.innerWidth;
      canvas.height = window.innerHeight;

      const particles = [];
      const colors = ['#d4af37', '#1a472a', '#722f37', '#faf8f3', '#e8c85a'];

      for (let i = 0; i < 100; i++) {
        particles.push({
          x: canvas.width / 2,
          y: canvas.height / 2,
          vx: (Math.random() - 0.5) * 15,
          vy: (Math.random() - 0.5) * 15 - 5,
          color: colors[Math.floor(Math.random() * colors.length)],
          size: Math.random() * 8 + 4,
          rotation: Math.random() * 360,
          rotationSpeed: (Math.random() - 0.5) * 10
        });
      }

      let frame = 0;
      function animate() {
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        
        particles.forEach(p => {
          p.x += p.vx;
          p.y += p.vy;
          p.vy += 0.3;
          p.rotation += p.rotationSpeed;

          ctx.save();
          ctx.translate(p.x, p.y);
          ctx.rotate(p.rotation * Math.PI / 180);
          ctx.fillStyle = p.color;
          ctx.fillRect(-p.size / 2, -p.size / 2, p.size, p.size);
          ctx.restore();
        });

        frame++;
        if (frame < 120) {
          requestAnimationFrame(animate);
        } else {
          ctx.clearRect(0, 0, canvas.width, canvas.height);
        }
      }
      animate();
    }

    // Initialize
    initSocket();

    // Check for room code in URL (supports ?room=CODE or /CODE)
    function checkUrlForRoom() {
      const urlParams = new URLSearchParams(window.location.search);
      let roomCode = urlParams.get('room');
      
      // Also check pathname for /CODE format
      if (!roomCode) {
        const path = window.location.pathname.slice(1); // Remove leading /
        if (path && /^[A-Za-z0-9]{6}$/.test(path)) {
          roomCode = path;
        }
      }
      
      if (roomCode) {
        roomCode = roomCode.toUpperCase();
        document.getElementById('roomCodeInput').value = roomCode;
        state.roomCode = roomCode;
        showToast(`Joining room ${roomCode}...`);
        showScreen('avatar');
      }
    }

    // Force uppercase on room code input
    document.getElementById('roomCodeInput').addEventListener('input', (e) => {
      e.target.value = e.target.value.toUpperCase();
    });
  </script>
</body>
</html>
