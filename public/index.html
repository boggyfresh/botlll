<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>White Elephant üéÅ</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@500;700&family=DM+Sans:wght@400;500;600&display=swap" rel="stylesheet">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.7.2/socket.io.min.js"></script>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    :root {
      --bg-primary: #1a1612;
      --bg-secondary: #2a2420;
      --bg-card: #322c28;
      --accent-warm: #e8a87c;
      --accent-red: #c94c4c;
      --accent-green: #6b9080;
      --accent-gold: #d4a574;
      --text-primary: #f5f0eb;
      --text-secondary: #a89f97;
      --text-muted: #6d6560;
      --border-subtle: rgba(232, 168, 124, 0.15);
      --shadow-glow: rgba(232, 168, 124, 0.2);
    }

    html, body, #root {
      height: 100%;
      width: 100%;
    }

    body {
      font-family: 'DM Sans', -apple-system, sans-serif;
      background: var(--bg-primary);
      color: var(--text-primary);
      overflow-x: hidden;
    }

    .app {
      min-height: 100%;
      display: flex;
      flex-direction: column;
      position: relative;
    }

    /* Animated background */
    .bg-pattern {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      pointer-events: none;
      opacity: 0.03;
      background-image: 
        radial-gradient(circle at 20% 30%, var(--accent-warm) 1px, transparent 1px),
        radial-gradient(circle at 80% 70%, var(--accent-gold) 1px, transparent 1px);
      background-size: 60px 60px, 80px 80px;
      animation: float 30s ease-in-out infinite;
    }

    @keyframes float {
      0%, 100% { transform: translate(0, 0); }
      50% { transform: translate(-20px, -20px); }
    }

    /* Header */
    .header {
      padding: 1.5rem;
      text-align: center;
      position: relative;
      z-index: 1;
    }

    .logo {
      font-family: 'Playfair Display', serif;
      font-size: 1.75rem;
      font-weight: 700;
      color: var(--accent-warm);
      letter-spacing: 0.02em;
    }

    .logo-emoji {
      display: inline-block;
      animation: wiggle 2s ease-in-out infinite;
    }

    @keyframes wiggle {
      0%, 100% { transform: rotate(-5deg); }
      50% { transform: rotate(5deg); }
    }

    .subtitle {
      font-size: 0.75rem;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.15em;
      margin-top: 0.25rem;
    }

    /* Main content */
    .main {
      flex: 1;
      padding: 1rem;
      max-width: 600px;
      margin: 0 auto;
      width: 100%;
      position: relative;
      z-index: 1;
    }

    /* Cards */
    .card {
      background: var(--bg-card);
      border-radius: 1.25rem;
      padding: 1.5rem;
      margin-bottom: 1rem;
      border: 1px solid var(--border-subtle);
      box-shadow: 0 4px 24px rgba(0, 0, 0, 0.3);
    }

    .card-title {
      font-family: 'Playfair Display', serif;
      font-size: 1.25rem;
      font-weight: 500;
      margin-bottom: 1rem;
      color: var(--text-primary);
    }

    /* Inputs */
    .input-group {
      margin-bottom: 1rem;
    }

    .label {
      display: block;
      font-size: 0.75rem;
      font-weight: 600;
      color: var(--text-secondary);
      text-transform: uppercase;
      letter-spacing: 0.1em;
      margin-bottom: 0.5rem;
    }

    .input {
      width: 100%;
      padding: 0.875rem 1rem;
      background: var(--bg-secondary);
      border: 1px solid var(--border-subtle);
      border-radius: 0.75rem;
      color: var(--text-primary);
      font-size: 1rem;
      font-family: inherit;
      transition: all 0.2s;
    }

    .input:focus {
      outline: none;
      border-color: var(--accent-warm);
      box-shadow: 0 0 0 3px var(--shadow-glow);
    }

    .input::placeholder {
      color: var(--text-muted);
    }

    /* Buttons */
    .btn {
      width: 100%;
      padding: 1rem 1.5rem;
      border: none;
      border-radius: 0.75rem;
      font-size: 0.9rem;
      font-weight: 600;
      font-family: inherit;
      cursor: pointer;
      transition: all 0.2s;
      text-transform: uppercase;
      letter-spacing: 0.1em;
    }

    .btn-primary {
      background: linear-gradient(135deg, var(--accent-warm) 0%, var(--accent-gold) 100%);
      color: var(--bg-primary);
    }

    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 24px var(--shadow-glow);
    }

    .btn-primary:active {
      transform: translateY(0);
    }

    .btn-primary:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      transform: none;
    }

    .btn-secondary {
      background: var(--bg-secondary);
      color: var(--text-primary);
      border: 1px solid var(--border-subtle);
    }

    .btn-secondary:hover {
      background: var(--bg-card);
      border-color: var(--accent-warm);
    }

    .btn-steal {
      background: linear-gradient(135deg, var(--accent-red) 0%, #a83a3a 100%);
      color: white;
    }

    .btn-steal:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 24px rgba(201, 76, 76, 0.3);
    }

    .btn-pool {
      background: linear-gradient(135deg, var(--accent-green) 0%, #5a7a6d 100%);
      color: white;
    }

    .btn-pool:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 24px rgba(107, 144, 128, 0.3);
    }

    /* Image upload */
    .image-upload {
      position: relative;
      width: 100%;
      aspect-ratio: 1;
      max-width: 200px;
      margin: 0 auto 1rem;
      border-radius: 1rem;
      overflow: hidden;
      background: var(--bg-secondary);
      border: 2px dashed var(--border-subtle);
      cursor: pointer;
      transition: all 0.2s;
    }

    .image-upload:hover {
      border-color: var(--accent-warm);
    }

    .image-upload.has-image {
      border-style: solid;
    }

    .image-upload img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .image-upload-placeholder {
      position: absolute;
      inset: 0;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      color: var(--text-muted);
    }

    .image-upload-icon {
      font-size: 2.5rem;
      margin-bottom: 0.5rem;
    }

    .image-upload-text {
      font-size: 0.75rem;
      text-transform: uppercase;
      letter-spacing: 0.1em;
    }

    .image-upload input {
      display: none;
    }

    /* Camera buttons */
    .camera-options {
      display: flex;
      gap: 0.5rem;
      margin-top: 0.75rem;
    }

    .camera-options .btn {
      flex: 1;
      padding: 0.75rem;
      font-size: 0.75rem;
    }

    /* Avatar */
    .avatar {
      width: 60px;
      height: 60px;
      border-radius: 50%;
      object-fit: cover;
      border: 2px solid var(--accent-warm);
    }

    .avatar-small {
      width: 44px;
      height: 44px;
    }

    /* Players list */
    .players-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
      gap: 0.75rem;
    }

    .player-card {
      background: var(--bg-secondary);
      border-radius: 1rem;
      padding: 1rem;
      text-align: center;
      border: 1px solid var(--border-subtle);
      transition: all 0.2s;
      position: relative;
    }

    .player-card.current-turn {
      border-color: var(--accent-warm);
      box-shadow: 0 0 20px var(--shadow-glow);
      animation: pulse 2s ease-in-out infinite;
    }

    @keyframes pulse {
      0%, 100% { box-shadow: 0 0 20px var(--shadow-glow); }
      50% { box-shadow: 0 0 30px var(--shadow-glow), 0 0 40px var(--shadow-glow); }
    }

    .player-card.has-gift {
      background: linear-gradient(135deg, var(--bg-secondary) 0%, rgba(107, 144, 128, 0.2) 100%);
    }

    .player-card.stealable {
      cursor: pointer;
    }

    .player-card.stealable:hover {
      border-color: var(--accent-red);
      transform: translateY(-2px);
    }

    .player-card.locked {
      opacity: 0.6;
    }

    .player-name {
      font-weight: 600;
      font-size: 0.875rem;
      margin-top: 0.5rem;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .player-status {
      font-size: 0.7rem;
      color: var(--text-muted);
      margin-top: 0.25rem;
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }

    .player-status.ready {
      color: var(--accent-green);
    }

    .gift-indicator {
      position: absolute;
      top: -8px;
      right: -8px;
      width: 32px;
      height: 32px;
      background: var(--accent-red);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1rem;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
    }

    .steal-count {
      position: absolute;
      bottom: -4px;
      right: -4px;
      background: var(--accent-warm);
      color: var(--bg-primary);
      font-size: 0.65rem;
      font-weight: 700;
      padding: 0.15rem 0.4rem;
      border-radius: 0.5rem;
    }

    /* Gift pool */
    .gift-pool {
      display: flex;
      flex-wrap: wrap;
      gap: 0.5rem;
      justify-content: center;
      padding: 1rem;
      background: var(--bg-secondary);
      border-radius: 1rem;
      min-height: 80px;
    }

    .gift-box {
      width: 50px;
      height: 50px;
      background: linear-gradient(135deg, var(--accent-red) 0%, #a83a3a 100%);
      border-radius: 0.5rem;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.5rem;
      box-shadow: 0 4px 12px rgba(201, 76, 76, 0.3);
      animation: bob 2s ease-in-out infinite;
    }

    .gift-box:nth-child(2n) {
      animation-delay: 0.5s;
    }

    .gift-box:nth-child(3n) {
      animation-delay: 1s;
    }

    @keyframes bob {
      0%, 100% { transform: translateY(0); }
      50% { transform: translateY(-5px); }
    }

    /* Turn indicator */
    .turn-indicator {
      background: linear-gradient(135deg, var(--accent-warm) 0%, var(--accent-gold) 100%);
      color: var(--bg-primary);
      padding: 0.75rem 1rem;
      border-radius: 0.75rem;
      text-align: center;
      font-weight: 600;
      margin-bottom: 1rem;
    }

    .turn-indicator.your-turn {
      animation: glow 1.5s ease-in-out infinite;
    }

    @keyframes glow {
      0%, 100% { box-shadow: 0 0 20px var(--shadow-glow); }
      50% { box-shadow: 0 0 30px var(--shadow-glow), 0 0 40px var(--accent-warm); }
    }

    /* Action buttons */
    .action-buttons {
      display: flex;
      gap: 0.75rem;
      margin-top: 1rem;
    }

    .action-buttons .btn {
      flex: 1;
    }

    /* Toast notifications */
    .toast {
      position: fixed;
      bottom: 2rem;
      left: 50%;
      transform: translateX(-50%);
      background: var(--bg-card);
      color: var(--text-primary);
      padding: 1rem 1.5rem;
      border-radius: 1rem;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4);
      z-index: 100;
      animation: slideUp 0.3s ease-out;
      max-width: calc(100% - 2rem);
      text-align: center;
      border: 1px solid var(--border-subtle);
    }

    @keyframes slideUp {
      from { transform: translate(-50%, 100%); opacity: 0; }
      to { transform: translate(-50%, 0); opacity: 1; }
    }

    /* Reveal screen */
    .reveal-card {
      text-align: center;
      padding: 2rem;
    }

    .reveal-gift-image {
      width: 100%;
      max-width: 280px;
      aspect-ratio: 1;
      object-fit: cover;
      border-radius: 1rem;
      margin: 1rem auto;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4);
      animation: revealIn 0.5s ease-out;
    }

    @keyframes revealIn {
      from { transform: scale(0.8); opacity: 0; }
      to { transform: scale(1); opacity: 1; }
    }

    .reveal-title {
      font-family: 'Playfair Display', serif;
      font-size: 1.5rem;
      margin-bottom: 0.5rem;
    }

    .reveal-recipient {
      color: var(--accent-warm);
      font-size: 0.875rem;
    }

    /* Game code */
    .game-code {
      background: var(--bg-secondary);
      padding: 0.75rem 1rem;
      border-radius: 0.75rem;
      text-align: center;
      margin-bottom: 1rem;
    }

    .game-code-label {
      font-size: 0.7rem;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.1em;
    }

    .game-code-value {
      font-family: 'Playfair Display', serif;
      font-size: 1.5rem;
      font-weight: 700;
      color: var(--accent-warm);
      letter-spacing: 0.2em;
      margin-top: 0.25rem;
    }

    /* Loading */
    .loading {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 0.5rem;
      color: var(--text-secondary);
    }

    .loading-dots {
      display: flex;
      gap: 0.25rem;
    }

    .loading-dot {
      width: 6px;
      height: 6px;
      background: var(--accent-warm);
      border-radius: 50%;
      animation: bounce 1.4s ease-in-out infinite both;
    }

    .loading-dot:nth-child(1) { animation-delay: -0.32s; }
    .loading-dot:nth-child(2) { animation-delay: -0.16s; }

    @keyframes bounce {
      0%, 80%, 100% { transform: scale(0); }
      40% { transform: scale(1); }
    }

    /* Confetti container */
    .confetti {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      pointer-events: none;
      z-index: 50;
    }

    .confetti-piece {
      position: absolute;
      width: 10px;
      height: 10px;
      animation: confetti-fall 4s ease-out forwards;
    }

    @keyframes confetti-fall {
      0% { transform: translateY(-100px) rotate(0deg); opacity: 1; }
      100% { transform: translateY(100vh) rotate(720deg); opacity: 0; }
    }

    /* Section divider */
    .divider {
      display: flex;
      align-items: center;
      gap: 1rem;
      margin: 1.5rem 0;
      color: var(--text-muted);
      font-size: 0.75rem;
      text-transform: uppercase;
      letter-spacing: 0.1em;
    }

    .divider::before,
    .divider::after {
      content: '';
      flex: 1;
      height: 1px;
      background: var(--border-subtle);
    }

    /* Video preview for camera */
    .video-preview {
      width: 100%;
      aspect-ratio: 1;
      max-width: 200px;
      margin: 0 auto;
      border-radius: 1rem;
      overflow: hidden;
      background: var(--bg-secondary);
    }

    .video-preview video {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    /* Responsive adjustments */
    @media (min-width: 480px) {
      .header {
        padding: 2rem;
      }

      .logo {
        font-size: 2rem;
      }

      .main {
        padding: 1.5rem;
      }

      .card {
        padding: 2rem;
      }
    }
  </style>
</head>
<body>
  <div id="root"></div>
  
  <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  
  <script type="text/babel">
    const { useState, useEffect, useRef, useCallback } = React;

    // Generate random game code
    const generateGameCode = () => {
      const chars = 'ABCDEFGHJKLMNPQRSTUVWXYZ23456789';
      return Array.from({ length: 4 }, () => chars[Math.floor(Math.random() * chars.length)]).join('');
    };

    // Get game code from URL or generate new one
    const getGameCode = () => {
      const params = new URLSearchParams(window.location.search);
      return params.get('game') || generateGameCode();
    };

    // Image compression
    const compressImage = (file, maxSize = 400) => {
      return new Promise((resolve) => {
        const reader = new FileReader();
        reader.onload = (e) => {
          const img = new Image();
          img.onload = () => {
            const canvas = document.createElement('canvas');
            let { width, height } = img;
            
            if (width > height) {
              if (width > maxSize) {
                height = (height * maxSize) / width;
                width = maxSize;
              }
            } else {
              if (height > maxSize) {
                width = (width * maxSize) / height;
                height = maxSize;
              }
            }
            
            canvas.width = width;
            canvas.height = height;
            const ctx = canvas.getContext('2d');
            ctx.drawImage(img, 0, 0, width, height);
            resolve(canvas.toDataURL('image/jpeg', 0.8));
          };
          img.src = e.target.result;
        };
        reader.readAsDataURL(file);
      });
    };

    // Toast notification component
    function Toast({ message, onClose }) {
      useEffect(() => {
        const timer = setTimeout(onClose, 3000);
        return () => clearTimeout(timer);
      }, [onClose]);

      return <div className="toast">{message}</div>;
    }

    // Confetti component
    function Confetti() {
      const colors = ['#e8a87c', '#c94c4c', '#6b9080', '#d4a574', '#f5f0eb'];
      const pieces = Array.from({ length: 50 }, (_, i) => ({
        id: i,
        left: Math.random() * 100,
        delay: Math.random() * 2,
        color: colors[Math.floor(Math.random() * colors.length)],
        size: 8 + Math.random() * 8
      }));

      return (
        <div className="confetti">
          {pieces.map(piece => (
            <div
              key={piece.id}
              className="confetti-piece"
              style={{
                left: `${piece.left}%`,
                animationDelay: `${piece.delay}s`,
                backgroundColor: piece.color,
                width: piece.size,
                height: piece.size,
                borderRadius: Math.random() > 0.5 ? '50%' : '0'
              }}
            />
          ))}
        </div>
      );
    }

    // Image upload component
    function ImageUpload({ value, onChange, placeholder, isAvatar }) {
      const fileInputRef = useRef(null);
      const videoRef = useRef(null);
      const [showCamera, setShowCamera] = useState(false);
      const [stream, setStream] = useState(null);

      const handleFileChange = async (e) => {
        const file = e.target.files[0];
        if (file) {
          const compressed = await compressImage(file, isAvatar ? 200 : 400);
          onChange(compressed);
        }
      };

      const startCamera = async () => {
        try {
          const mediaStream = await navigator.mediaDevices.getUserMedia({ 
            video: { facingMode: isAvatar ? 'user' : 'environment' } 
          });
          setStream(mediaStream);
          setShowCamera(true);
        } catch (err) {
          console.error('Camera access denied:', err);
          alert('Could not access camera. Please upload an image instead.');
        }
      };

      const capturePhoto = () => {
        if (videoRef.current) {
          const canvas = document.createElement('canvas');
          const size = isAvatar ? 200 : 400;
          canvas.width = size;
          canvas.height = size;
          const ctx = canvas.getContext('2d');
          
          const video = videoRef.current;
          const vw = video.videoWidth;
          const vh = video.videoHeight;
          const min = Math.min(vw, vh);
          const sx = (vw - min) / 2;
          const sy = (vh - min) / 2;
          
          ctx.drawImage(video, sx, sy, min, min, 0, 0, size, size);
          const dataUrl = canvas.toDataURL('image/jpeg', 0.8);
          onChange(dataUrl);
          stopCamera();
        }
      };

      const stopCamera = () => {
        if (stream) {
          stream.getTracks().forEach(track => track.stop());
          setStream(null);
        }
        setShowCamera(false);
      };

      useEffect(() => {
        if (showCamera && videoRef.current && stream) {
          videoRef.current.srcObject = stream;
        }
      }, [showCamera, stream]);

      useEffect(() => {
        return () => {
          if (stream) {
            stream.getTracks().forEach(track => track.stop());
          }
        };
      }, [stream]);

      if (showCamera) {
        return (
          <div>
            <div className="video-preview">
              <video ref={videoRef} autoPlay playsInline muted />
            </div>
            <div className="camera-options">
              <button className="btn btn-primary" onClick={capturePhoto}>üì∏ Capture</button>
              <button className="btn btn-secondary" onClick={stopCamera}>Cancel</button>
            </div>
          </div>
        );
      }

      return (
        <div>
          <div 
            className={`image-upload ${value ? 'has-image' : ''}`}
            onClick={() => fileInputRef.current?.click()}
            style={isAvatar ? { borderRadius: '50%' } : {}}
          >
            {value ? (
              <img src={value} alt="Preview" />
            ) : (
              <div className="image-upload-placeholder">
                <div className="image-upload-icon">{isAvatar ? 'üë§' : 'üéÅ'}</div>
                <div className="image-upload-text">{placeholder}</div>
              </div>
            )}
            <input
              ref={fileInputRef}
              type="file"
              accept="image/*"
              onChange={handleFileChange}
            />
          </div>
          <div className="camera-options">
            <button className="btn btn-secondary" onClick={startCamera}>üì∑ Camera</button>
            <button className="btn btn-secondary" onClick={() => fileInputRef.current?.click()}>üìÅ Upload</button>
          </div>
        </div>
      );
    }

    // Main App
    function App() {
      const [socket, setSocket] = useState(null);
      const [gameCode] = useState(getGameCode);
      const [phase, setPhase] = useState('setup'); // setup, gift, lobby, playing, revealing, finished
      const [playerName, setPlayerName] = useState('');
      const [avatar, setAvatar] = useState(null);
      const [giftTitle, setGiftTitle] = useState('');
      const [giftImage, setGiftImage] = useState(null);
      const [gameState, setGameState] = useState(null);
      const [toast, setToast] = useState(null);
      const [revealedGift, setRevealedGift] = useState(null);
      const [showConfetti, setShowConfetti] = useState(false);
      const [isConnected, setIsConnected] = useState(false);

      // Update URL with game code
      useEffect(() => {
        const url = new URL(window.location);
        url.searchParams.set('game', gameCode);
        window.history.replaceState({}, '', url);
      }, [gameCode]);

      // Socket connection
      useEffect(() => {
        const newSocket = io(window.location.origin);
        
        newSocket.on('connect', () => {
          setIsConnected(true);
          setSocket(newSocket);
        });

        newSocket.on('disconnect', () => {
          setIsConnected(false);
        });

        newSocket.on('gameState', (state) => {
          setGameState(state);
          if (state.phase === 'playing' && phase === 'lobby') {
            setPhase('playing');
          } else if (state.phase === 'revealing' && phase !== 'revealing' && phase !== 'finished') {
            setPhase('revealing');
          } else if (state.phase === 'finished') {
            setPhase('finished');
            setShowConfetti(true);
          }
        });

        newSocket.on('action', ({ type, playerName, targetName, giftTitle }) => {
          if (type === 'took') {
            setToast(`${playerName} took a gift from the pool!`);
          } else if (type === 'stole') {
            setToast(`${playerName} stole from ${targetName}! üòà`);
          }
        });

        newSocket.on('giftRevealed', ({ playerName, gift }) => {
          setRevealedGift({ playerName, ...gift });
        });

        newSocket.on('error', ({ message }) => {
          setToast(`‚ö†Ô∏è ${message}`);
        });

        return () => newSocket.close();
      }, []);

      const joinGame = () => {
        if (!playerName.trim() || !avatar) {
          setToast('Please enter your name and add a photo!');
          return;
        }
        socket.emit('joinGame', { gameId: gameCode, playerName: playerName.trim(), avatar });
        setPhase('gift');
      };

      const submitGift = () => {
        if (!giftTitle.trim() || !giftImage) {
          setToast('Please add a gift title and photo!');
          return;
        }
        socket.emit('submitGift', { title: giftTitle.trim(), image: giftImage });
        setPhase('lobby');
      };

      const startGame = () => {
        socket.emit('startGame');
      };

      const takeFromPool = () => {
        socket.emit('takeFromPool');
      };

      const stealGift = (targetPlayerId) => {
        socket.emit('stealGift', { targetPlayerId });
      };

      const revealNext = () => {
        setRevealedGift(null);
        socket.emit('revealNext');
      };

      const isMyTurn = gameState?.currentPlayerId === socket?.id;
      const myPlayer = gameState?.players.find(p => p.id === socket?.id);
      const canStealFrom = (player) => {
        if (!isMyTurn || !player.currentGift || player.id === socket?.id) return false;
        if (gameState?.lastStolenFrom === player.id) return false;
        return true;
      };

      const shareLink = `${window.location.origin}?game=${gameCode}`;

      return (
        <div className="app">
          <div className="bg-pattern" />
          
          <header className="header">
            <h1 className="logo">
              White Elephant <span className="logo-emoji">üéÅ</span>
            </h1>
            <p className="subtitle">Virtual Gift Exchange</p>
          </header>

          <main className="main">
            {/* Setup Phase */}
            {phase === 'setup' && (
              <div className="card">
                <h2 className="card-title">Join the Party</h2>
                
                <div className="game-code">
                  <div className="game-code-label">Game Code</div>
                  <div className="game-code-value">{gameCode}</div>
                </div>

                <p style={{ fontSize: '0.875rem', color: 'var(--text-secondary)', marginBottom: '1rem', textAlign: 'center' }}>
                  Share this link with friends:
                </p>
                <div className="input-group">
                  <input 
                    className="input" 
                    value={shareLink} 
                    readOnly 
                    onClick={(e) => {
                      e.target.select();
                      navigator.clipboard?.writeText(shareLink);
                      setToast('Link copied!');
                    }}
                    style={{ cursor: 'pointer', fontSize: '0.8rem' }}
                  />
                </div>

                <div className="divider">Your Profile</div>

                <ImageUpload 
                  value={avatar} 
                  onChange={setAvatar} 
                  placeholder="Add photo"
                  isAvatar
                />

                <div className="input-group" style={{ marginTop: '1rem' }}>
                  <label className="label">Your Name</label>
                  <input
                    className="input"
                    type="text"
                    placeholder="Enter your name"
                    value={playerName}
                    onChange={(e) => setPlayerName(e.target.value)}
                    maxLength={20}
                  />
                </div>

                <button 
                  className="btn btn-primary" 
                  onClick={joinGame}
                  disabled={!isConnected}
                >
                  {isConnected ? 'Join Game' : 'Connecting...'}
                </button>
              </div>
            )}

            {/* Gift Upload Phase */}
            {phase === 'gift' && (
              <div className="card">
                <h2 className="card-title">Add Your Gift</h2>
                <p style={{ fontSize: '0.875rem', color: 'var(--text-secondary)', marginBottom: '1.5rem' }}>
                  Take a photo of your wrapped gift. Don't worry, no one else can see it yet! ü§´
                </p>

                <ImageUpload 
                  value={giftImage} 
                  onChange={setGiftImage} 
                  placeholder="Add gift photo"
                />

                <div className="input-group" style={{ marginTop: '1rem' }}>
                  <label className="label">What is it?</label>
                  <input
                    className="input"
                    type="text"
                    placeholder="e.g., Cozy blanket"
                    value={giftTitle}
                    onChange={(e) => setGiftTitle(e.target.value)}
                    maxLength={30}
                  />
                </div>

                <button className="btn btn-primary" onClick={submitGift}>
                  Submit Gift
                </button>
              </div>
            )}

            {/* Lobby Phase */}
            {phase === 'lobby' && gameState && (
              <>
                <div className="card">
                  <div className="game-code">
                    <div className="game-code-label">Game Code</div>
                    <div className="game-code-value">{gameCode}</div>
                  </div>
                  
                  <h2 className="card-title">Waiting for Players</h2>
                  
                  <div className="players-grid">
                    {gameState.players.map(player => (
                      <div key={player.id} className={`player-card ${player.isReady ? 'has-gift' : ''}`}>
                        <img src={player.avatar} alt={player.name} className="avatar" />
                        <div className="player-name">{player.name}</div>
                        <div className={`player-status ${player.isReady ? 'ready' : ''}`}>
                          {player.isReady ? '‚úì Ready' : 'Adding gift...'}
                        </div>
                      </div>
                    ))}
                  </div>

                  {gameState.players.length >= 2 && gameState.players.every(p => p.isReady) && (
                    <button className="btn btn-primary" onClick={startGame} style={{ marginTop: '1.5rem' }}>
                      Start Game! üéâ
                    </button>
                  )}
                  
                  {gameState.players.length < 2 && (
                    <p style={{ textAlign: 'center', color: 'var(--text-muted)', marginTop: '1rem', fontSize: '0.875rem' }}>
                      Need at least 2 players to start
                    </p>
                  )}
                </div>
              </>
            )}

            {/* Playing Phase */}
            {phase === 'playing' && gameState && (
              <>
                <div className={`turn-indicator ${isMyTurn ? 'your-turn' : ''}`}>
                  {isMyTurn ? "üéØ It's your turn!" : `${gameState.players.find(p => p.id === gameState.currentPlayerId)?.name}'s turn`}
                </div>

                {gameState.giftPoolCount > 0 && (
                  <div className="card">
                    <h3 className="card-title">Gift Pool ({gameState.giftPoolCount})</h3>
                    <div className="gift-pool">
                      {Array.from({ length: gameState.giftPoolCount }, (_, i) => (
                        <div key={i} className="gift-box">üéÅ</div>
                      ))}
                    </div>
                    {isMyTurn && !myPlayer?.currentGift && (
                      <button className="btn btn-pool" onClick={takeFromPool} style={{ marginTop: '1rem' }}>
                        Take from Pool
                      </button>
                    )}
                  </div>
                )}

                <div className="card">
                  <h3 className="card-title">Players</h3>
                  <div className="players-grid">
                    {gameState.players.map(player => {
                      const isStealable = canStealFrom(player);
                      const isLocked = player.currentGift && gameState.stealCounts?.[player.currentGift.id] >= 3;
                      
                      return (
                        <div 
                          key={player.id} 
                          className={`player-card ${player.currentGift ? 'has-gift' : ''} ${isStealable ? 'stealable' : ''} ${player.id === gameState.currentPlayerId ? 'current-turn' : ''} ${isLocked ? 'locked' : ''}`}
                          onClick={() => isStealable && stealGift(player.id)}
                        >
                          {player.currentGift && <div className="gift-indicator">üéÅ</div>}
                          <img src={player.avatar} alt={player.name} className="avatar avatar-small" />
                          <div className="player-name">
                            {player.name}
                            {player.id === socket?.id && ' (you)'}
                          </div>
                          {player.currentGift && (
                            <div className="player-status">
                              {isLocked ? 'üîí Locked' : 'Has gift'}
                            </div>
                          )}
                          {isStealable && <div className="player-status" style={{ color: 'var(--accent-red)' }}>Tap to steal!</div>}
                        </div>
                      );
                    })}
                  </div>
                </div>
              </>
            )}

            {/* Revealing Phase */}
            {(phase === 'revealing' || phase === 'finished') && gameState && (
              <>
                {showConfetti && <Confetti />}
                
                {revealedGift ? (
                  <div className="card reveal-card">
                    <h2 className="card-title">üéâ Gift Revealed!</h2>
                    <img src={revealedGift.image} alt={revealedGift.title} className="reveal-gift-image" />
                    <div className="reveal-title">{revealedGift.title}</div>
                    <div className="reveal-recipient">Goes to {revealedGift.playerName}</div>
                    
                    {phase === 'revealing' && (
                      <button className="btn btn-primary" onClick={revealNext} style={{ marginTop: '1.5rem' }}>
                        Next Reveal ‚Üí
                      </button>
                    )}
                  </div>
                ) : phase === 'revealing' ? (
                  <div className="card" style={{ textAlign: 'center' }}>
                    <h2 className="card-title">üéÅ Time to Reveal!</h2>
                    <p style={{ color: 'var(--text-secondary)', marginBottom: '1.5rem' }}>
                      Let's see what everyone got!
                    </p>
                    <button className="btn btn-primary" onClick={revealNext}>
                      Start Revealing
                    </button>
                  </div>
                ) : null}

                {phase === 'finished' && (
                  <div className="card">
                    <h2 className="card-title">üéä Game Complete!</h2>
                    <p style={{ color: 'var(--text-secondary)', marginBottom: '1rem', textAlign: 'center' }}>
                      Don't forget to mail your gifts to the winners!
                    </p>
                    <div className="players-grid">
                      {gameState.players.map(player => (
                        <div key={player.id} className="player-card has-gift">
                          <img src={player.avatar} alt={player.name} className="avatar avatar-small" />
                          <div className="player-name">{player.name}</div>
                          {player.currentGift && (
                            <div className="player-status" style={{ color: 'var(--accent-warm)' }}>
                              {player.currentGift.title}
                            </div>
                          )}
                        </div>
                      ))}
                    </div>
                  </div>
                )}
              </>
            )}
          </main>

          {toast && <Toast message={toast} onClose={() => setToast(null)} />}
        </div>
      );
    }

    ReactDOM.createRoot(document.getElementById('root')).render(<App />);
  </script>
</body>
</html>
